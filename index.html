<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1e40af">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">
    <title>BAHIA GMAO V7.3</title>
    <style>
        :root{--primary:#1e40af;--primary-l:#3b82f6;--secondary:#f59e0b;--success:#10b981;--danger:#ef4444;--purple:#8b5cf6;--g50:#f8fafc;--g100:#f1f5f9;--g200:#e2e8f0;--g300:#cbd5e1;--g400:#94a3b8;--g500:#64748b;--g600:#475569;--g700:#334155;--g800:#1e293b}
        *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--g100);min-height:100vh;color:var(--g800)}
        .login-page{min-height:100vh;display:flex;flex-direction:column;background:linear-gradient(180deg,var(--primary),var(--primary-l))}
        .login-header{padding:50px 24px 30px;text-align:center;color:#fff}
        .login-header .logo{font-size:56px;margin-bottom:12px}
        .login-header h1{font-size:26px;font-weight:700}
        .login-header p{opacity:.9;font-size:14px;margin-top:6px}
        .login-box{flex:1;background:#fff;border-radius:28px 28px 0 0;padding:28px 20px}
        .login-box h2{font-size:20px;margin-bottom:20px}
        .fg{margin-bottom:16px}
        .fg label{display:block;font-size:13px;font-weight:600;color:var(--g600);margin-bottom:6px}
        .inpbox{position:relative}
        .inpbox .ico{position:absolute;left:14px;top:50%;transform:translateY(-50%);font-size:18px;color:var(--g400)}
        .inpbox input{width:100%;padding:14px 14px 14px 46px;border:2px solid var(--g200);border-radius:12px;font-size:15px;background:var(--g50)}
        .inpbox input:focus{outline:none;border-color:var(--primary);background:#fff}
        .inpbox .toggle{position:absolute;right:14px;top:50%;transform:translateY(-50%);background:none;border:none;font-size:18px;cursor:pointer;color:var(--g400);padding:4px}
        .remember{display:flex;align-items:center;gap:8px;margin-bottom:20px}
        .remember input{width:18px;height:18px;accent-color:var(--primary)}
        .remember label{font-size:13px;color:var(--g600)}
        .btn-login{width:100%;padding:16px;background:var(--primary);color:#fff;border:none;border-radius:12px;font-size:16px;font-weight:700;cursor:pointer;box-shadow:0 4px 15px rgba(30,64,175,.3)}
        .btn-login:disabled{background:var(--g400);box-shadow:none}
        .login-err{background:#fef2f2;border:1px solid #fecaca;color:var(--danger);padding:12px;border-radius:10px;margin-bottom:16px;font-size:13px;display:none}
        .login-footer{text-align:center;margin-top:20px}
        .login-footer a{color:var(--primary);font-size:13px;font-weight:600;text-decoration:none}
        .app{display:none;min-height:100vh;padding-bottom:90px}
        .app.active{display:block}
        .header{background:#fff;padding:12px 16px;position:sticky;top:0;z-index:100;box-shadow:0 4px 20px rgba(0,0,0,.08)}
        .header-row{display:flex;justify-content:space-between;align-items:center}
        .header-left{display:flex;align-items:center;gap:10px}
        .avatar{width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,var(--primary),var(--primary-l));color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:18px}
        .user-info h1{font-size:15px;font-weight:700}
        .user-info .role{font-size:12px;color:var(--g500)}
        .header-btns{display:flex;gap:6px}
        .hbtn{width:40px;height:40px;border-radius:10px;background:var(--g100);border:none;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center}
        .hbtn.danger{background:#fef2f2}
        .hbtn.print{background:#e0f2fe}
        .status-row{display:flex;align-items:center;justify-content:center;gap:6px;margin-top:8px;padding:6px 12px;background:var(--g50);border-radius:8px;font-size:12px;color:var(--g600)}
        .status-dot{width:8px;height:8px;border-radius:50%}
        .status-dot.on{background:var(--success)}
        .status-dot.off{background:var(--danger)}
        .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:#fff;padding:6px 8px 20px;display:flex;justify-content:space-around;box-shadow:0 -4px 20px rgba(0,0,0,.1);z-index:1000}
        .nav-item{display:flex;flex-direction:column;align-items:center;gap:2px;padding:8px 12px;border-radius:12px;background:none;border:none;color:var(--g400);font-size:11px;font-weight:600;cursor:pointer;position:relative}
        .nav-item .nav-ico{font-size:22px}
        .nav-item.active{color:var(--primary);background:#eff6ff}
        .nav-item.hidden{display:none}
        .nav-badge{position:absolute;top:2px;right:2px;background:var(--danger);color:#fff;font-size:10px;min-width:16px;height:16px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700}
        .page{display:none;padding:16px;padding-bottom:180px}
        .page.active{display:block}
        .page-title{font-size:22px;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:10px}
        .page-title .refresh{background:var(--g100);border:none;width:36px;height:36px;border-radius:10px;font-size:16px;cursor:pointer;margin-left:auto}
        .stats{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:20px}
        .stat{background:#fff;border-radius:16px;padding:14px;box-shadow:0 4px 20px rgba(0,0,0,.08)}
        .stat .val{font-size:28px;font-weight:700;color:var(--primary)}
        .stat .lbl{font-size:12px;color:var(--g500);margin-top:2px}
        .stat.warn .val{color:var(--secondary)}
        .stat.ok .val{color:var(--success)}
        .stat.bad .val{color:var(--danger)}
        .card{background:#fff;border-radius:16px;padding:16px;margin-bottom:12px;box-shadow:0 4px 20px rgba(0,0,0,.08)}
        .card-head{display:flex;align-items:center;gap:10px;margin-bottom:12px}
        .card-ico{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px}
        .card-ico.blue{background:#dbeafe}
        .card-ico.orange{background:#fef3c7}
        .card-ico.green{background:#d1fae5}
        .card-ico.purple{background:#ede9fe}
        .card-ico.red{background:#fee2e2}
        .card-title{font-size:15px;font-weight:700}
        .card-sub{font-size:12px;color:var(--g500)}
        .flabel{font-size:13px;font-weight:600;color:var(--g600);margin-bottom:6px;display:block}
        .fselect,.finput,.ftextarea{width:100%;padding:12px 14px;border:2px solid var(--g200);border-radius:10px;font-size:15px;background:var(--g50);color:var(--g800)}
        .fselect:focus,.finput:focus,.ftextarea:focus{outline:none;border-color:var(--primary);background:#fff}
        .fselect{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:40px}
        .ftextarea{resize:none;min-height:80px}
        .textarea-wrap{position:relative}
        .textarea-wrap .ftextarea{padding-right:50px}
        .voice-btn{position:absolute;right:8px;top:8px;width:40px;height:40px;border-radius:50%;border:none;background:linear-gradient(135deg,var(--danger),#dc2626);color:#fff;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(239,68,68,.3);transition:all .2s}
        .voice-btn:hover{transform:scale(1.1)}
        .voice-btn.recording{animation:pulse 1s infinite}
        @keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,.4)}50%{box-shadow:0 0 0 15px rgba(239,68,68,0)}}
        .user-badge{background:linear-gradient(135deg,var(--primary),var(--primary-l));color:#fff;padding:12px 16px;border-radius:12px;display:flex;align-items:center;gap:10px}
        .user-badge .ub-ico{font-size:24px}
        .user-badge .ub-info{flex:1}
        .user-badge .ub-name{font-weight:700;font-size:15px}
        .user-badge .ub-role{font-size:12px;opacity:.9}
        .chips{display:flex;flex-wrap:wrap;gap:8px}
        .chip{padding:10px 16px;background:var(--g100);border:2px solid var(--g200);border-radius:25px;font-size:14px;font-weight:600;color:var(--g600);cursor:pointer}
        .chip.sel{background:var(--primary);border-color:var(--primary);color:#fff}
        .chip.sm{padding:8px 12px;font-size:12px}
        .list-box{background:#fff;border-radius:16px;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,.08)}
        .list-item{padding:14px;border-bottom:1px solid var(--g100);cursor:pointer;position:relative}
        .list-item:last-child{border-bottom:none}
        .list-item:active{background:var(--g50)}
        .list-item.sel{background:#eff6ff;border-left:4px solid var(--primary)}
        .list-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
        .list-id{font-weight:700;color:var(--primary);font-size:13px}
        .list-date{font-size:11px;color:var(--g400)}
        .list-title{font-size:14px;font-weight:600}
        .list-sub{font-size:12px;color:var(--g500)}
        .list-actions{position:absolute;right:10px;top:50%;transform:translateY(-50%);display:flex;gap:6px}
        .list-actions .act-btn{width:32px;height:32px;border-radius:8px;border:none;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center}
        .list-actions .act-btn.edit{background:#dbeafe;color:var(--primary)}
        .list-actions .act-btn.del{background:#fee2e2;color:var(--danger)}
        .badge{display:inline-block;padding:3px 8px;border-radius:12px;font-size:11px;font-weight:600}
        .badge.warn{background:#fef3c7;color:#92400e}
        .badge.ok{background:#d1fae5;color:#065f46}
        .badge.info{background:#dbeafe;color:#1e40af}
        .badge.bad{background:#fee2e2;color:#991b1b}
        .search{position:relative;margin-bottom:12px}
        .search input{width:100%;padding:12px 12px 12px 42px;border:2px solid var(--g200);border-radius:12px;font-size:15px;background:#fff}
        .search input:focus{outline:none;border-color:var(--primary)}
        .search .sico{position:absolute;left:14px;top:50%;transform:translateY(-50%);font-size:18px;color:var(--g400)}
        .filters{display:flex;gap:6px;margin-bottom:12px;overflow-x:auto;padding-bottom:4px}
        .fbtn{padding:8px 14px;background:#fff;border:2px solid var(--g200);border-radius:8px;font-size:13px;font-weight:600;color:var(--g600);cursor:pointer;white-space:nowrap}
        .fbtn.active{background:var(--primary);border-color:var(--primary);color:#fff}
        .tech-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
        .tech-item{display:flex;align-items:center;gap:8px;padding:10px;background:var(--g50);border:2px solid var(--g200);border-radius:10px;cursor:pointer}
        .tech-item.sel{background:#dbeafe;border-color:var(--primary)}
        .tech-item input{width:18px;height:18px;accent-color:var(--primary);pointer-events:none}
        .tech-name{font-weight:600;font-size:13px}
        .tech-spec{font-size:10px;color:var(--g500)}
        .pieces-box{max-height:220px;overflow-y:auto;background:#fff;border-radius:16px;border:2px solid var(--g200)}
        .piece{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid var(--g100);cursor:pointer}
        .piece:last-child{border-bottom:none}
        .piece.sel{background:#fef3c7}
        .piece input[type="checkbox"]{width:18px;height:18px;accent-color:var(--secondary)}
        .piece-info{flex:1;min-width:0}
        .piece-code{font-weight:700;color:var(--primary);font-size:12px}
        .piece-name{font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .piece-stock{font-size:11px;color:var(--g500)}
        .piece-qty input{width:50px;padding:6px;text-align:center;border:2px solid var(--g200);border-radius:6px;font-weight:700;font-size:14px}
        .sel-tags{margin-top:10px;padding:10px;background:var(--g50);border-radius:8px;font-size:12px}
        .sel-tags .tag{display:inline-block;background:#fff;padding:3px 8px;border-radius:5px;margin:2px;font-weight:600;border:1px solid var(--g200)}
        .dur-row{display:flex;align-items:center;gap:10px}
        .dur-row input{width:90px;text-align:center;font-size:22px;font-weight:700}
        .dur-row span{font-size:14px;color:var(--g500)}
        .quick-btns{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px}
        .qbtn{padding:8px 14px;background:var(--g100);border:none;border-radius:8px;font-size:13px;font-weight:600;color:var(--g600);cursor:pointer}
        .qbtn:active{background:var(--primary);color:#fff}
        .timer-box{background:var(--g800);border-radius:16px;padding:20px;text-align:center;color:#fff;margin-bottom:12px}
        .timer-display{font-size:42px;font-weight:700;font-family:monospace;margin-bottom:12px}
        .timer-btns{display:flex;gap:10px;justify-content:center}
        .timer-btn{padding:12px 24px;border:none;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer}
        .timer-btn.start{background:var(--success);color:#fff}
        .timer-btn.stop{background:var(--danger);color:#fff}
        .timer-btn.reset{background:var(--g600);color:#fff}
        .timer-sm{background:var(--danger);border-radius:12px;padding:12px;text-align:center;color:#fff;margin-bottom:12px}
        .photo-btns{display:flex;gap:10px}
        .photo-btn{flex:1;padding:16px;border:2px dashed var(--g300);border-radius:12px;background:var(--g50);text-align:center;cursor:pointer}
        .photo-btn .pico{font-size:28px;margin-bottom:6px}
        .photo-btn .plbl{font-size:13px;font-weight:600;color:var(--g600)}
        .photo-preview{position:relative;margin-top:10px}
        .photo-preview img{width:100%;max-height:180px;object-fit:cover;border-radius:10px}
        .photo-preview .rm{position:absolute;top:6px;right:6px;width:28px;height:28px;background:var(--danger);color:#fff;border:none;border-radius:50%;font-size:16px;cursor:pointer}
        input[type="file"]{display:none}
        .bt-card{background:linear-gradient(135deg,var(--secondary),#d97706);border-radius:16px;padding:16px;color:#fff;margin-bottom:12px}
        .bt-card .btid{font-size:18px;font-weight:700}
        .bt-card .btano{font-size:13px;opacity:.9;margin-top:4px}
        .preview{background:var(--g50);border-radius:10px;padding:14px;font-size:13px;line-height:1.6;white-space:pre-wrap;max-height:180px;overflow-y:auto}
        .success-box{background:linear-gradient(135deg,#ecfdf5,#d1fae5);border:2px solid var(--success);border-radius:16px;padding:30px 20px;text-align:center}
        .success-box .sico{font-size:56px;margin-bottom:12px}
        .success-box h3{font-size:20px;color:#065f46;margin-bottom:6px}
        .success-box p{color:#047857;margin-bottom:12px;font-size:14px}
        .success-box .sid{background:#fff;padding:8px 16px;border-radius:8px;font-family:monospace;font-size:16px;font-weight:700;color:var(--primary);display:inline-block}
        .success-box.orange{background:linear-gradient(135deg,#fef3c7,#fde68a);border-color:var(--secondary)}
        .success-box.orange h3{color:#92400e}
        .success-box.orange p{color:#a16207}
        .success-box.purple{background:linear-gradient(135deg,#f3e8ff,#e9d5ff);border-color:var(--purple)}
        .success-box.purple h3{color:#6b21a8}
        .success-box.purple p{color:#7c3aed}
        .action-bar{position:fixed;bottom:70px;left:0;right:0;padding:10px 16px;background:#fff;box-shadow:0 -4px 20px rgba(0,0,0,.1);display:none;z-index:999}
        .action-bar.show{display:block}
        .action-btns{display:flex;gap:8px}
        .btn{flex:1;padding:14px;border:none;border-radius:12px;font-size:15px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px}
        .btn:disabled{opacity:.5}
        .btn-primary{background:var(--primary);color:#fff;box-shadow:0 4px 12px rgba(30,64,175,.25)}
        .btn-success{background:var(--success);color:#fff}
        .btn-warning{background:var(--secondary);color:#fff}
        .btn-purple{background:var(--purple);color:#fff}
        .btn-danger{background:var(--danger);color:#fff}
        .btn-wa{background:#25D366;color:#fff;max-width:56px}
        .btn-wa svg{width:22px;height:22px;fill:#fff}
        .btn-reset{width:100%;margin-top:8px;padding:12px;background:var(--g100);color:var(--g600);border:2px solid var(--g200);border-radius:10px;font-weight:600;cursor:pointer}
        .modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:flex;align-items:flex-end;z-index:2000}
        .modal.center{align-items:center;padding:20px}
        .modal.hidden{display:none}
        .modal-box{background:#fff;border-radius:20px 20px 0 0;padding:20px;width:100%;max-height:80vh;overflow-y:auto}
        .modal.center .modal-box{border-radius:20px;max-width:400px}
        .modal-handle{width:36px;height:4px;background:var(--g300);border-radius:2px;margin:0 auto 16px}
        .modal-title{font-size:18px;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:10px}
        .modal-btns{display:flex;gap:10px;margin-top:20px}
        .modal-btns .btn{padding:12px}
        .print-option{padding:16px;border:2px solid var(--g200);border-radius:12px;margin-bottom:10px;cursor:pointer;display:flex;align-items:center;gap:12px}
        .print-option:hover{border-color:var(--primary);background:var(--g50)}
        .print-option.sel{border-color:var(--primary);background:#eff6ff}
        .print-option .po-ico{font-size:28px}
        .print-option .po-title{font-weight:700}
        .print-option .po-sub{font-size:12px;color:var(--g500)}
        .voice-modal-content{text-align:center;padding:20px 0}
        .voice-animation{width:120px;height:120px;margin:0 auto 20px;border-radius:50%;background:linear-gradient(135deg,var(--danger),#dc2626);display:flex;align-items:center;justify-content:center;font-size:50px;position:relative}
        .voice-animation.recording::before{content:'';position:absolute;width:100%;height:100%;border-radius:50%;border:4px solid var(--danger);animation:voicePulse 1.5s infinite}
        .voice-animation.processing{background:linear-gradient(135deg,var(--primary),var(--primary-l))}
        @keyframes voicePulse{0%{transform:scale(1);opacity:1}100%{transform:scale(1.5);opacity:0}}
        .voice-status{font-size:18px;font-weight:700;color:var(--g800);margin-bottom:8px}
        .voice-sub{font-size:14px;color:var(--g500)}
        .voice-timer{font-size:32px;font-weight:700;font-family:monospace;color:var(--danger);margin:16px 0}
        .voice-result{background:var(--g50);border-radius:12px;padding:16px;margin-top:20px;text-align:left}
        .voice-result label{font-size:12px;font-weight:600;color:var(--g500);margin-bottom:8px;display:block}
        .voice-result textarea{width:100%;min-height:100px;padding:12px;border:2px solid var(--g200);border-radius:10px;font-size:15px;resize:none}
        .voice-result textarea:focus{outline:none;border-color:var(--primary)}
        .toast{position:fixed;top:70px;left:50%;transform:translateX(-50%);padding:12px 20px;border-radius:10px;font-weight:600;font-size:14px;z-index:3000;animation:slideD .3s;box-shadow:0 10px 40px rgba(0,0,0,.15)}
        .toast.success{background:var(--success);color:#fff}
        .toast.error{background:var(--danger);color:#fff}
        .toast.info{background:var(--primary);color:#fff}
        @keyframes slideD{from{opacity:0;transform:translateX(-50%) translateY(-20px)}}
        .loading{text-align:center;padding:40px}
        .spinner{width:40px;height:40px;border:4px solid var(--g200);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 12px}
        @keyframes spin{to{transform:rotate(360deg)}}
        .loading p{color:var(--g500);font-size:14px}
        .overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.8);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:3000;color:#fff}
        .overlay.hidden{display:none}
        .overlay .spinner{border-color:rgba(255,255,255,.3);border-top-color:#fff}
        .overlay p{margin-top:12px;font-size:15px}
        .empty{text-align:center;padding:30px;color:var(--g500)}
        .empty .eico{font-size:40px;opacity:.5;margin-bottom:10px}
        .hidden{display:none!important}
        .mt12{margin-top:12px}
        .mb12{margin-bottom:12px}
        @media print{body *{visibility:hidden}.print-area,.print-area *{visibility:visible}.print-area{position:absolute;left:0;top:0;width:100%}}
        ::-webkit-scrollbar{width:4px;height:4px}
        ::-webkit-scrollbar-thumb{background:var(--g300);border-radius:2px}
    </style>
</head>
<body>
    <!-- LOGIN -->
    <div class="login-page" id="loginPage">
        <div class="login-header">
            <div class="logo">üè≠</div>
            <h1>BAHIA AGADIR</h1>
            <p>Gestion Maintenance Assist√©e par Ordinateur</p>
        </div>
        <div class="login-box">
            <form class="login-form" onsubmit="handleLogin(event)">
                <h2>Connexion</h2>
                <div class="login-err" id="loginErr"></div>
                <div class="fg">
                    <label>Identifiant</label>
                    <div class="inpbox">
                        <span class="ico">üë§</span>
                        <input type="text" id="loginUser" placeholder="Votre identifiant" required>
                    </div>
                </div>
                <div class="fg">
                    <label>Mot de passe</label>
                    <div class="inpbox">
                        <span class="ico">üîí</span>
                        <input type="password" id="loginPwd" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                        <button type="button" class="toggle" onclick="togglePwd('loginPwd')">üëÅÔ∏è</button>
                    </div>
                </div>
                <div class="remember">
                    <input type="checkbox" id="rememberMe">
                    <label for="rememberMe">Se souvenir de moi</label>
                </div>
                <button type="submit" class="btn-login" id="btnLogin">Se connecter</button>
                <div class="login-footer"><a href="#" onclick="showConfig()">‚öôÔ∏è Configuration serveur</a></div>
            </form>
        </div>
    </div>

    <!-- APP -->
    <div class="app" id="app">
        <div class="header">
            <div class="header-row">
                <div class="header-left">
                    <div class="avatar" id="avatar">J</div>
                    <div class="user-info"><h1 id="uName">-</h1><div class="role" id="uRole">-</div></div>
                </div>
                <div class="header-btns">
                    <button class="hbtn print" onclick="showPrintModal()">üñ®Ô∏è</button>
                    <button class="hbtn" onclick="refreshData()">üîÑ</button>
                    <button class="hbtn" onclick="showConfig()">‚öôÔ∏è</button>
                    <button class="hbtn danger" onclick="logout()">üö™</button>
                </div>
            </div>
            <div class="status-row"><span class="status-dot" id="sDot"></span><span id="sText">Connexion...</span></div>
        </div>

        <!-- Dashboard -->
        <div class="page active" id="pgDash">
            <h2 class="page-title">üìä Tableau de bord</h2>
            <div class="stats">
                <div class="stat warn"><div class="val" id="stAno">0</div><div class="lbl">Anomalies en cours</div></div>
                <div class="stat ok"><div class="val" id="stBT">0</div><div class="lbl">BT ce mois</div></div>
                <div class="stat bad"><div class="val" id="stStock">0</div><div class="lbl">Stock bas</div></div>
                <div class="stat"><div class="val" id="stSortie">0</div><div class="lbl">Sorties PDR</div></div>
            </div>
            <div style="font-weight:700;font-size:16px;margin-bottom:10px;">üìã Derni√®res anomalies</div>
            <div id="dashAnoList"></div>
        </div>

        <!-- Signalement -->
        <div class="page" id="pgSig">
            <h2 class="page-title">üö® Signalement <button class="refresh" onclick="resetSig()">üîÑ</button></h2>
            <div id="sigLoading" class="loading"><div class="spinner"></div><p>Chargement...</p></div>
            <div id="sigApp" class="hidden">
                <!-- Timer arr√™t production -->
                <div class="timer-sm" id="sigTimerBox">
                    <div style="font-size:12px;opacity:.9;margin-bottom:4px">‚è±Ô∏è Temps d'arr√™t machine</div>
                    <div style="font-size:28px;font-weight:700;font-family:monospace" id="sigTimerVal">00:00:00</div>
                    <div style="display:flex;gap:8px;justify-content:center;margin-top:10px">
                        <button style="padding:8px 16px;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;background:#fff;color:var(--danger)" id="sigTimerStart" onclick="startSigTimer()">‚ñ∂Ô∏è D√©marrer</button>
                        <button style="padding:8px 16px;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;background:rgba(255,255,255,.2);color:#fff" class="hidden" id="sigTimerStop" onclick="stopSigTimer()">‚èπÔ∏è Stop</button>
                        <button style="padding:8px 16px;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;background:rgba(255,255,255,.2);color:#fff" onclick="resetSigTimer()">‚Ü∫ Reset</button>
                    </div>
                </div>
                <!-- Op√©rateur auto -->
                <div class="card" id="sig1"><div class="card-head"><div class="card-ico blue">1</div><div><div class="card-title">Op√©rateur</div></div></div><div class="user-badge"><div class="ub-ico">üë§</div><div class="ub-info"><div class="ub-name" id="sigOpName">-</div><div class="ub-role" id="sigOpRole">Chargement...</div></div></div></div>
                <div class="card" id="sig2"><div class="card-head"><div class="card-ico blue">2</div><div><div class="card-title">Ligne</div></div></div><div class="chips" id="sigLignes"></div></div>
                <div class="card hidden" id="sig3"><div class="card-head"><div class="card-ico blue">3</div><div><div class="card-title">Machine</div></div></div><div class="chips" id="sigMachines"></div></div>
                <div class="card hidden" id="sig4"><div class="card-head"><div class="card-ico blue">4</div><div><div class="card-title">Zone</div></div></div><select class="fselect" id="sigZone" onchange="selectSigZone(this.value)"><option value="">-- S√©lectionner --</option></select></div>
                <div class="card hidden" id="sig5"><div class="card-head"><div class="card-ico blue">5</div><div><div class="card-title">Composant</div></div></div><select class="fselect" id="sigComp" onchange="selectSigComp(this.value)"><option value="">-- S√©lectionner --</option></select><input type="text" class="finput mt12 hidden" id="sigCompAutre" placeholder="Pr√©cisez..." oninput="updateSigPreview()"></div>
                <div class="card hidden" id="sig6"><div class="card-head"><div class="card-ico red">6</div><div><div class="card-title">Anomalie</div></div></div><select class="fselect" id="sigAno" onchange="selectSigAno(this.value)"><option value="">-- S√©lectionner --</option></select><input type="text" class="finput mt12 hidden" id="sigAnoAutre" placeholder="D√©crivez..." oninput="updateSigPreview()"></div>
                <div class="card hidden" id="sig7"><div class="card-head"><div class="card-ico orange">7</div><div><div class="card-title">Technicien(s)</div></div></div><div class="tech-grid" id="sigTechs"></div><div class="sel-tags hidden mt12" id="sigSelTechs"></div></div>
                <div class="card hidden" id="sig8"><div class="card-head"><div class="card-ico green">8</div><div><div class="card-title">Dur√©e (manuel)</div></div></div><div class="dur-row"><input type="number" class="finput" id="sigDuree" min="1" placeholder="0" oninput="updateSigPreview()"><span>min</span></div><div class="quick-btns"><button class="qbtn" onclick="setSigDur(5)">5</button><button class="qbtn" onclick="setSigDur(10)">10</button><button class="qbtn" onclick="setSigDur(15)">15</button><button class="qbtn" onclick="setSigDur(30)">30</button><button class="qbtn" onclick="setSigDur(60)">60</button></div></div>
                <div class="card hidden" id="sig9"><div class="card-head"><div class="card-ico purple">9</div><div><div class="card-title">Photo</div></div></div><div class="photo-btns"><label class="photo-btn" for="sigCam"><div class="pico">üì∑</div><div class="plbl">Cam√©ra</div></label><label class="photo-btn" for="sigGal"><div class="pico">üñºÔ∏è</div><div class="plbl">Galerie</div></label></div><input type="file" id="sigCam" accept="image/*" capture="environment" onchange="handleSigPhoto(this)"><input type="file" id="sigGal" accept="image/*" onchange="handleSigPhoto(this)"><div class="photo-preview hidden" id="sigPhotoPreview"><img id="sigPhotoImg" src=""><button class="rm" onclick="removeSigPhoto()">‚úï</button></div></div>
                <div class="card hidden" id="sig10"><div class="card-head"><div class="card-ico blue">10</div><div><div class="card-title">Commentaire</div><div class="card-sub">üé§ Cliquez sur le micro pour dicter</div></div></div><div class="textarea-wrap"><textarea class="ftextarea" id="sigComment" placeholder="D√©tails suppl√©mentaires..." oninput="updateSigPreview()"></textarea><button class="voice-btn" onclick="startVoiceInput('sigComment')" title="Saisie vocale">üé§</button></div></div>
                <div class="card hidden" id="sigPreviewCard"><div class="card-head"><div class="card-ico green">üìã</div><div><div class="card-title">Aper√ßu</div></div></div><div class="preview" id="sigPreview"></div></div>
                <div class="success-box hidden" id="sigSuccess"><div class="sico">‚úÖ</div><h3>Anomalie Enregistr√©e !</h3><p>Sauvegard√©e dans la base</p><div class="sid" id="sigSuccessId">-</div></div>
            </div>
        </div>

        <!-- Maintenance -->
        <div class="page" id="pgMaint">
            <h2 class="page-title">üîß Maintenance <button class="refresh" onclick="loadAnomalies()">üîÑ</button></h2>
            <div id="maintLoading" class="loading"><div class="spinner"></div><p>Chargement...</p></div>
            <div id="maintApp" class="hidden">
                <div class="filters mb12">
                    <button class="fbtn active" onclick="filterAno(this,'encours')">üîÑ En cours</button>
                    <button class="fbtn" onclick="filterAno(this,'attente')">‚è≥ Attente</button>
                    <button class="fbtn" onclick="filterAno(this,'cloture')">‚úÖ Cl√¥tur√©s</button>
                    <button class="fbtn" onclick="filterAno(this,'all')">üìã Tous</button>
                </div>
                <div class="search"><span class="sico">üîç</span><input type="text" id="searchAno" placeholder="Rechercher ID, machine..." oninput="filterAnoSearch()"></div>
                <div class="list-box mb12" id="anoList"></div>
                <div class="hidden" id="btForm">
                    <div class="bt-card">
                        <div class="btid" id="btId">BT-YYYYMMDD-XXXX</div>
                        <div class="btano">Anomalie: <span id="btAnoRef">-</span> | <span id="btAnoMachine">-</span></div>
                        <div style="display:flex;gap:8px;margin-top:12px">
                            <button style="padding:8px 16px;background:rgba(255,255,255,.2);border:none;border-radius:8px;color:#fff;font-weight:600;font-size:12px;cursor:pointer" class="btact" onclick="quickBtStatus('En cours')">üîÑ En cours</button>
                            <button style="padding:8px 16px;background:rgba(255,255,255,.2);border:none;border-radius:8px;color:#fff;font-weight:600;font-size:12px;cursor:pointer" class="btact" onclick="quickBtStatus('Attente pi√®ce')">‚è≥ Attente</button>
                            <button style="padding:8px 16px;background:rgba(255,255,255,.2);border:none;border-radius:8px;color:#fff;font-weight:600;font-size:12px;cursor:pointer" class="btact" onclick="quickBtStatus('Cl√¥tur√©')">‚úÖ Cl√¥tur√©</button>
                        </div>
                    </div>
                    <div class="card"><div class="card-head"><div class="card-ico orange">üë®‚Äçüîß</div><div><div class="card-title">Technicien responsable</div></div></div><select class="fselect" id="btTech" onchange="updateBtPreview()"><option value="">-- S√©lectionner --</option></select></div>
                    <div class="card"><div class="card-head"><div class="card-ico blue">üîç</div><div><div class="card-title">Diagnostic</div><div class="card-sub">üé§ Utilisez le micro pour dicter</div></div></div><select class="fselect mb12" id="btCause" onchange="updateBtPreview()"><option value="">-- Cause --</option><option>Usure normale</option><option>D√©faut mat√©riel</option><option>Erreur op√©rateur</option><option>Probl√®me r√©glage</option><option>Manque lubrification</option><option>Corps √©tranger</option><option>D√©faut √©lectrique</option><option>D√©faut pneumatique</option><option>Autre</option></select><div class="textarea-wrap"><textarea class="ftextarea" id="btDiag" placeholder="D√©tail diagnostic..." oninput="updateBtPreview()"></textarea><button class="voice-btn" onclick="startVoiceInput('btDiag')" title="Saisie vocale">üé§</button></div></div>
                    <div class="card"><div class="card-head"><div class="card-ico green">üõ†Ô∏è</div><div><div class="card-title">Action corrective</div><div class="card-sub">üé§ Utilisez le micro pour dicter</div></div></div><select class="fselect mb12" id="btAction" onchange="updateBtPreview()"><option value="">-- Action --</option><option>Remplacement pi√®ce</option><option>R√©paration</option><option>R√©glage</option><option>Nettoyage</option><option>Lubrification</option><option>Resserrage</option><option>Autre</option></select><div class="textarea-wrap"><textarea class="ftextarea" id="btActionDetail" placeholder="D√©tail action..." oninput="updateBtPreview()"></textarea><button class="voice-btn" onclick="startVoiceInput('btActionDetail')" title="Saisie vocale">üé§</button></div></div>
                    <div class="card"><div class="card-head"><div class="card-ico purple">üì¶</div><div><div class="card-title">Pi√®ces utilis√©es</div></div></div><div class="search mb12"><span class="sico">üîç</span><input type="text" id="searchPieceBT" placeholder="Rechercher..." oninput="filterPiecesBT()"></div><div class="pieces-box" id="piecesBT"></div><div class="sel-tags hidden mt12" id="selPiecesBT"></div></div>
                    <div class="card"><div class="card-head"><div class="card-ico orange">‚è±Ô∏è</div><div><div class="card-title">Temps intervention</div></div></div><div class="timer-box"><div class="timer-display" id="timerDisplay">00:00:00</div><div class="timer-btns"><button class="timer-btn start" id="timerStart" onclick="startTimer()">‚ñ∂Ô∏è Start</button><button class="timer-btn stop hidden" id="timerStop" onclick="stopTimer()">‚èπÔ∏è Stop</button><button class="timer-btn reset" onclick="resetTimer()">‚Ü∫</button></div></div><div class="dur-row mt12"><span>Ou saisir:</span><input type="number" class="finput" id="btDuree" min="1" placeholder="0" oninput="updateBtPreview()" style="width:80px"><span>min</span></div></div>
                    <div class="card"><div class="card-head"><div class="card-ico green">‚úÖ</div><div><div class="card-title">Statut</div></div></div><div class="chips"><div class="chip sm" onclick="setBtStatut(this,'En cours')">üîÑ En cours</div><div class="chip sm" onclick="setBtStatut(this,'Cl√¥tur√©')">‚úÖ Cl√¥tur√©</div><div class="chip sm" onclick="setBtStatut(this,'Attente pi√®ce')">‚è≥ Attente</div></div></div>
                    <div class="card"><div class="card-head"><div class="card-ico green">üìã</div><div><div class="card-title">Aper√ßu BT</div></div></div><div class="preview" id="btPreview"></div></div>
                </div>
                <div class="success-box orange hidden" id="btSuccess"><div class="sico">üîß</div><h3>BT Enregistr√© !</h3><p>Intervention sauvegard√©e</p><div class="sid" id="btSuccessId">-</div></div>
            </div>
        </div>

        <!-- PDR -->
        <div class="page" id="pgPDR">
            <h2 class="page-title">üì¶ Gestion PDR <button class="refresh" onclick="refreshData()">üîÑ</button></h2>
            <div id="pdrLoading" class="loading"><div class="spinner"></div><p>Chargement...</p></div>
            <div id="pdrApp" class="hidden">
                <div class="stats mb12">
                    <div class="stat"><div class="val" id="pdrTotal">0</div><div class="lbl">Total r√©f√©rences</div></div>
                    <div class="stat bad"><div class="val" id="pdrBas">0</div><div class="lbl">Stock critique</div></div>
                </div>
                <div class="card"><div class="card-head"><div class="card-ico purple">üì§</div><div><div class="card-title">Nouvelle sortie</div></div></div>
                    <label class="flabel">Machine</label>
                    <select class="fselect mb12" id="pdrMachine" onchange="updatePdrPreview()"><option value="">-- S√©lectionner --</option></select>
                    <label class="flabel">Motif</label>
                    <select class="fselect mb12" id="pdrMotif" onchange="updatePdrPreview()"><option value="">-- S√©lectionner --</option><option>Maintenance pr√©ventive</option><option>Maintenance corrective</option><option>Remplacement usure</option><option>Stock tampon</option><option>Autre</option></select>
                    <label class="flabel">R√©f√©rence BT (depuis liste)</label>
                    <select class="fselect" id="pdrBtRef" onchange="updatePdrPreview()"><option value="">-- Aucun BT --</option></select>
                </div>
                <div class="card"><div class="card-head"><div class="card-ico purple">üîß</div><div><div class="card-title">Pi√®ces √† sortir</div></div></div>
                    <div class="search mb12"><span class="sico">üîç</span><input type="text" id="searchPiecePDR" placeholder="Rechercher..." oninput="filterPiecesPDR()"></div>
                    <div class="filters mb12">
                        <button class="fbtn active" onclick="filterPdrType(this,'all')">Tous</button>
                        <button class="fbtn" onclick="filterPdrType(this,'M√©canique')">M√©ca</button>
                        <button class="fbtn" onclick="filterPdrType(this,'√âlectrique')">√âlec</button>
                        <button class="fbtn" onclick="filterPdrType(this,'Pneumatique')">Pneum</button>
                    </div>
                    <div class="pieces-box" id="piecesPDR"></div>
                    <div class="sel-tags hidden mt12" id="selPiecesPDR"></div>
                </div>
                <div class="card hidden" id="pdrPreviewCard"><div class="card-head"><div class="card-ico green">üìã</div><div><div class="card-title">Aper√ßu</div></div></div><div class="preview" id="pdrPreview"></div></div>
                <div class="success-box purple hidden" id="pdrSuccess"><div class="sico">üì¶</div><h3>Sortie Enregistr√©e !</h3><p>Stock mis √† jour</p><div class="sid" id="pdrSuccessId">-</div></div>
                <div class="card mt12"><div class="card-head"><div class="card-ico red">üìä</div><div><div class="card-title">Historique sorties</div></div></div>
                    <div style="max-height:200px;overflow-y:auto">
                        <table style="width:100%;font-size:12px;border-collapse:collapse">
                            <thead style="background:var(--purple);color:#fff"><tr><th style="padding:8px;text-align:left">Date</th><th>Code</th><th>Qt√©</th><th>Machine</th></tr></thead>
                            <tbody id="pdrHistory"><tr><td colspan="4" style="text-align:center;padding:20px;color:var(--g400)">Aucune sortie</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Nav -->
        <div class="bottom-nav">
            <button class="nav-item active" onclick="goPage('pgDash',this)"><span class="nav-ico">üìä</span>Accueil</button>
            <button class="nav-item" id="navSig" onclick="goPage('pgSig',this)"><span class="nav-ico">üö®</span>Signaler</button>
            <button class="nav-item" id="navMaint" onclick="goPage('pgMaint',this)"><span class="nav-ico">üîß</span>Maintenance<span class="nav-badge hidden" id="badgeAno">0</span></button>
            <button class="nav-item" id="navPDR" onclick="goPage('pgPDR',this)"><span class="nav-ico">üì¶</span>PDR</button>
        </div>

        <!-- Action Bars -->
        <div class="action-bar" id="actionSig">
            <div class="action-btns" id="sigBtns">
                <button class="btn btn-primary" id="btnSaveSig" onclick="saveSig()" disabled>üíæ Enregistrer</button>
                <button class="btn btn-wa" id="btnWaSig" onclick="sendWaSig()" disabled><svg viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg></button>
            </div>
            <button class="btn-reset hidden" id="btnResetSig" onclick="resetSig()">üîÑ Nouveau signalement</button>
        </div>
        <div class="action-bar" id="actionMaint">
            <div class="action-btns" id="maintBtns">
                <button class="btn btn-warning" id="btnSaveBT" onclick="saveBT()" disabled>üíæ Enregistrer BT</button>
                <button class="btn btn-wa" id="btnWaBT" onclick="sendWaBT()" disabled><svg viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg></button>
            </div>
            <button class="btn-reset hidden" id="btnResetBT" onclick="resetBT()">üîÑ Nouvelle intervention</button>
        </div>
        <div class="action-bar" id="actionPDR">
            <div class="action-btns" id="pdrBtns"><button class="btn btn-purple" id="btnSavePDR" onclick="savePDR()" disabled>üíæ Valider sortie</button></div>
            <button class="btn-reset hidden" id="btnResetPDR" onclick="resetPDR()">üîÑ Nouvelle sortie</button>
        </div>
    </div>

    <!-- Config Modal -->
    <div class="modal center hidden" id="configModal">
        <div class="modal-box">
            <div class="modal-title">‚öôÔ∏è Configuration</div>
            <div class="fg"><label class="flabel">URL du Script Google</label><input type="text" class="finput" id="cfgUrl" placeholder="https://script.google.com/..."></div>
            <div class="fg"><label class="flabel">Token de s√©curit√©</label><div class="inpbox"><span class="ico">üîë</span><input type="password" class="finput" id="cfgToken" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="padding-left:46px"><button type="button" class="toggle" onclick="togglePwd('cfgToken')">üëÅÔ∏è</button></div></div>
            <div class="fg"><label class="flabel">üé§ Cl√© API Gemini (pour saisie vocale)</label><input type="text" class="finput" id="cfgGemini" placeholder="AIzaSy..."></div>
            <div style="font-size:12px;color:var(--g500);margin-bottom:12px">Obtenez votre cl√© sur <a href="https://aistudio.google.com/apikey" target="_blank" style="color:var(--primary)">aistudio.google.com</a></div>
            <button class="btn btn-success" onclick="testConnection()" style="width:100%;margin-bottom:10px">üîÑ Tester connexion</button>
            <div class="modal-btns"><button class="btn" style="flex:1;background:var(--g100);color:var(--g600)" onclick="hideConfig()">Annuler</button><button class="btn btn-primary" style="flex:1" onclick="saveConfig()">Enregistrer</button></div>
        </div>
    </div>

    <!-- Print Modal -->
    <div class="modal center hidden" id="printModal">
        <div class="modal-box">
            <div class="modal-title">üñ®Ô∏è Imprimer Historique</div>
            <div class="print-option" onclick="selectPrintType('sig')">
                <div class="po-ico">üö®</div>
                <div><div class="po-title">Historique Signalements</div><div class="po-sub">Liste des anomalies signal√©es</div></div>
            </div>
            <div class="print-option" onclick="selectPrintType('bt')">
                <div class="po-ico">üîß</div>
                <div><div class="po-title">Historique Bons de Travail</div><div class="po-sub">Liste des interventions maintenance</div></div>
            </div>
            <div class="print-option" onclick="selectPrintType('pdr')">
                <div class="po-ico">üì¶</div>
                <div><div class="po-title">Historique Sorties PDR</div><div class="po-sub">Liste des sorties de pi√®ces</div></div>
            </div>
            <div class="modal-btns">
                <button class="btn" style="flex:1;background:var(--g100);color:var(--g600)" onclick="hidePrintModal()">Annuler</button>
                <button class="btn btn-primary" style="flex:1" id="btnPrint" onclick="doPrint()" disabled>üñ®Ô∏è Imprimer</button>
            </div>
        </div>
    </div>

    <!-- Voice Modal -->
    <div class="modal center hidden" id="voiceModal">
        <div class="modal-box">
            <div class="modal-title">üé§ Saisie Vocale</div>
            <div class="voice-modal-content">
                <div class="voice-animation" id="voiceAnim">üé§</div>
                <div class="voice-status" id="voiceStatus">Appuyez pour parler</div>
                <div class="voice-sub" id="voiceSub">Maintenez le bouton ou cliquez pour d√©marrer</div>
                <div class="voice-timer hidden" id="voiceTimer">00:00</div>
                <div class="voice-result hidden" id="voiceResult">
                    <label>Texte transcrit (modifiable) :</label>
                    <textarea id="voiceText" placeholder="Le texte appara√Ætra ici..."></textarea>
                </div>
            </div>
            <div class="modal-btns">
                <button class="btn" style="flex:1;background:var(--g100);color:var(--g600)" onclick="cancelVoice()">Annuler</button>
                <button class="btn btn-danger" style="flex:1" id="btnVoiceRecord" onclick="toggleVoiceRecord()">üé§ Enregistrer</button>
                <button class="btn btn-success hidden" style="flex:1" id="btnVoiceConfirm" onclick="confirmVoice()">‚úÖ Valider</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirm Modal -->
    <div class="modal center hidden" id="deleteModal">
        <div class="modal-box">
            <div class="modal-title">üóëÔ∏è Confirmer suppression</div>
            <p id="deleteMsg" style="margin-bottom:16px;color:var(--g600)">Voulez-vous vraiment supprimer cet √©l√©ment ?</p>
            <div class="modal-btns">
                <button class="btn" style="flex:1;background:var(--g100);color:var(--g600)" onclick="hideDeleteModal()">Annuler</button>
                <button class="btn btn-danger" style="flex:1" onclick="confirmDelete()">üóëÔ∏è Supprimer</button>
            </div>
        </div>
    </div>

    <!-- Overlay -->
    <div class="overlay hidden" id="overlay"><div class="spinner"></div><p id="overlayText">Enregistrement...</p></div>

    <!-- Print Area (hidden) -->
    <div id="printArea" class="print-area hidden"></div>

    <script>
    // ============ VARIABLES ============
    let user=null,db=null,allAno=[],allBT=[],allPieces=[],history=[],currentAnoFilter='encours',currentPdrType='all';
    let sigData={ligne:'',machine:'',zone:'',comp:'',ano:'',techs:[]},sigPhoto=null,sigPhotoUrl=null,savedSigId=null;
    let sigTimerInterval=null,sigTimerSeconds=0;
    let btData={ano:null,pieces:[],statut:''},savedBtId=null,timerInterval=null,timerSeconds=0;
    let pdrData={pieces:[]},savedPdrId=null;
    let editMode=null,editId=null,deleteType=null,deleteId=null,printType=null;
    
    // Voice input
    let voiceTargetId=null,mediaRecorder=null,audioChunks=[],voiceTimerInterval=null,voiceSeconds=0,isRecording=false;
    
    const ROLES={admin:{label:'Admin',tabs:['pgSig','pgMaint','pgPDR'],edit:true},production:{label:'Production',tabs:['pgSig'],edit:true},maintenance:{label:'Maintenance',tabs:['pgMaint','pgPDR'],edit:true},direction:{label:'Direction',tabs:['pgSig','pgMaint','pgPDR'],edit:false}};

    document.addEventListener('DOMContentLoaded',()=>{loadCfg();checkUser()});
    function checkUser(){const s=localStorage.getItem('bahia_user');if(s){try{user=JSON.parse(s);showApp()}catch(e){localStorage.removeItem('bahia_user')}}}
    
    // ============ LOGIN ============
    async function handleLogin(e){e.preventDefault();const uid=document.getElementById('loginUser').value.trim(),pwd=document.getElementById('loginPwd').value,rem=document.getElementById('rememberMe').checked;document.getElementById('btnLogin').disabled=true;document.getElementById('btnLogin').textContent='Connexion...';document.getElementById('loginErr').style.display='none';const url=localStorage.getItem('bahia_url'),token=localStorage.getItem('bahia_token');if(!url||!token){showLoginErr('‚öôÔ∏è Configurez le serveur');resetLoginBtn();return}try{const r=await fetch(`${url}?token=${encodeURIComponent(token)}&action=login&username=${encodeURIComponent(uid)}&password=${encodeURIComponent(pwd)}`);const res=await r.json();if(res.success&&res.user){user=res.user;if(rem)localStorage.setItem('bahia_user',JSON.stringify(user));showApp()}else{showLoginErr(res.error||'Identifiants incorrects')}}catch(err){showLoginErr('Erreur connexion')}resetLoginBtn()}
    function showLoginErr(m){const el=document.getElementById('loginErr');el.textContent='‚ùå '+m;el.style.display='block'}
    function resetLoginBtn(){document.getElementById('btnLogin').disabled=false;document.getElementById('btnLogin').textContent='Se connecter'}
    function togglePwd(id){const i=document.getElementById(id);i.type=i.type==='password'?'text':'password'}
    function logout(){user=null;localStorage.removeItem('bahia_user');document.getElementById('app').classList.remove('active');document.getElementById('loginPage').style.display='flex';document.getElementById('loginUser').value='';document.getElementById('loginPwd').value=''}
    function showApp(){document.getElementById('loginPage').style.display='none';document.getElementById('app').classList.add('active');document.getElementById('avatar').textContent=user.nom.charAt(0).toUpperCase();document.getElementById('uName').textContent=user.nom;document.getElementById('uRole').textContent=ROLES[user.role]?.label||user.role;setupTabs();loadData()}
    function setupTabs(){const r=ROLES[user.role]||ROLES.production;document.getElementById('navSig').classList.toggle('hidden',!r.tabs.includes('pgSig'));document.getElementById('navMaint').classList.toggle('hidden',!r.tabs.includes('pgMaint'));document.getElementById('navPDR').classList.toggle('hidden',!r.tabs.includes('pgPDR'))}
    
    // ============ CONFIG ============
    function loadCfg(){document.getElementById('cfgUrl').value=localStorage.getItem('bahia_url')||'';document.getElementById('cfgToken').value=localStorage.getItem('bahia_token')||'';document.getElementById('cfgGemini').value=localStorage.getItem('bahia_gemini')||''}
    function showConfig(){document.getElementById('configModal').classList.remove('hidden')}
    function hideConfig(){document.getElementById('configModal').classList.add('hidden')}
    function saveConfig(){const url=document.getElementById('cfgUrl').value.trim(),token=document.getElementById('cfgToken').value.trim(),gemini=document.getElementById('cfgGemini').value.trim();if(url)localStorage.setItem('bahia_url',url);if(token)localStorage.setItem('bahia_token',token);if(gemini)localStorage.setItem('bahia_gemini',gemini);hideConfig();toast('‚úÖ Configuration enregistr√©e');if(user)loadData()}
    async function testConnection(){const url=document.getElementById('cfgUrl').value.trim(),token=document.getElementById('cfgToken').value.trim();try{const r=await fetch(`${url}?token=${encodeURIComponent(token)}&action=test`);const res=await r.json();toast(res.success?'‚úÖ Connexion OK':'‚ùå '+(res.error||'Erreur'),res.success?'success':'error')}catch(e){toast('‚ùå Erreur','error')}}
    
    // ============ DATA ============
    async function loadData(){const url=localStorage.getItem('bahia_url'),token=localStorage.getItem('bahia_token');if(!url||!token){setStatus(false,'Non configur√©');return}try{const r=await fetch(`${url}?token=${encodeURIComponent(token)}`);db=await r.json();if(db.error)throw new Error(db.error);setStatus(true,'Connect√©');allPieces=db.pieces||[];initSig();initMaint();initPDR();loadAnomalies();loadBTs();loadHistory();updateDashboard()}catch(e){setStatus(false,'Erreur');console.error(e)}}
    function refreshData(){toast('üîÑ Actualisation...','info');loadData()}
    function setStatus(on,t){document.getElementById('sDot').className='status-dot '+(on?'on':'off');document.getElementById('sText').textContent=(on?'‚úÖ ':'‚ùå ')+t}
    
    // ============ NAVIGATION ============
    function goPage(id,el){document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));document.querySelectorAll('.action-bar').forEach(a=>a.classList.remove('show'));document.getElementById(id).classList.add('active');if(el)el.classList.add('active');if(id==='pgSig')document.getElementById('actionSig').classList.add('show');if(id==='pgMaint')document.getElementById('actionMaint').classList.add('show');if(id==='pgPDR')document.getElementById('actionPDR').classList.add('show')}
    
    // ============ DASHBOARD ============
    function updateDashboard(){const enc=allAno.filter(a=>a.Statut!=='Cl√¥tur√©').length,clo=allAno.filter(a=>a.Statut==='Cl√¥tur√©').length,bas=allPieces.filter(p=>(p.Stock||0)<=5).length;document.getElementById('stAno').textContent=enc;document.getElementById('stBT').textContent=clo;document.getElementById('stStock').textContent=bas;document.getElementById('stSortie').textContent=history.length;document.getElementById('badgeAno').textContent=enc;document.getElementById('badgeAno').classList.toggle('hidden',enc===0);const d=document.getElementById('dashAnoList'),recent=allAno.slice(0,5);d.innerHTML=recent.length?'<div class="list-box">'+recent.map(a=>`<div class="list-item" onclick="goToAno('${a.ID}')"><div class="list-row"><span class="list-id">${a.ID}</span><span class="badge ${a.Statut==='Cl√¥tur√©'?'ok':(a.Statut==='Attente pi√®ce'?'info':'warn')}">${a.Statut||'En cours'}</span></div><div class="list-title">${a.Machine} - ${a.Anomalie}</div><div class="list-sub">${a.Date||''}</div></div>`).join('')+'</div>':'<div class="empty"><div class="eico">üìã</div>Aucune anomalie</div>'}
    function goToAno(id){document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));document.getElementById('navMaint').classList.add('active');goPage('pgMaint',null);document.getElementById('searchAno').value=id;filterAnoSearch()}
    
    // ============ VOICE INPUT (GEMINI API) ============
    function startVoiceInput(targetId){
        const geminiKey=localStorage.getItem('bahia_gemini');
        if(!geminiKey){toast('‚ùå Configurez la cl√© API Gemini dans ‚öôÔ∏è','error');return}
        voiceTargetId=targetId;
        document.getElementById('voiceModal').classList.remove('hidden');
        document.getElementById('voiceAnim').classList.remove('recording','processing');
        document.getElementById('voiceStatus').textContent='Cliquez pour enregistrer';
        document.getElementById('voiceSub').textContent='Parlez clairement en fran√ßais ou arabe';
        document.getElementById('voiceTimer').classList.add('hidden');
        document.getElementById('voiceResult').classList.add('hidden');
        document.getElementById('btnVoiceRecord').classList.remove('hidden');
        document.getElementById('btnVoiceConfirm').classList.add('hidden');
        document.getElementById('btnVoiceRecord').textContent='üé§ Enregistrer';
        document.getElementById('btnVoiceRecord').className='btn btn-danger';
        isRecording=false;audioChunks=[];voiceSeconds=0
    }
    
    async function toggleVoiceRecord(){
        if(!isRecording){
            try{
                const stream=await navigator.mediaDevices.getUserMedia({audio:true});
                mediaRecorder=new MediaRecorder(stream,{mimeType:'audio/webm'});
                audioChunks=[];
                mediaRecorder.ondataavailable=e=>{if(e.data.size>0)audioChunks.push(e.data)};
                mediaRecorder.onstop=()=>{stream.getTracks().forEach(t=>t.stop());processAudio()};
                mediaRecorder.start();
                isRecording=true;
                document.getElementById('voiceAnim').classList.add('recording');
                document.getElementById('voiceStatus').textContent='üî¥ Enregistrement...';
                document.getElementById('voiceSub').textContent='Parlez maintenant';
                document.getElementById('voiceTimer').classList.remove('hidden');
                document.getElementById('btnVoiceRecord').textContent='‚èπÔ∏è Arr√™ter';
                document.getElementById('btnVoiceRecord').className='btn btn-success';
                voiceTimerInterval=setInterval(()=>{voiceSeconds++;const m=Math.floor(voiceSeconds/60),s=voiceSeconds%60;document.getElementById('voiceTimer').textContent=String(m).padStart(2,'0')+':'+String(s).padStart(2,'0')},1000)
            }catch(e){toast('‚ùå Acc√®s micro refus√©','error');console.error(e)}
        }else{
            clearInterval(voiceTimerInterval);
            mediaRecorder.stop();
            isRecording=false;
            document.getElementById('voiceAnim').classList.remove('recording');
            document.getElementById('voiceAnim').classList.add('processing');
            document.getElementById('voiceStatus').textContent='‚è≥ Transcription...';
            document.getElementById('voiceSub').textContent='Envoi vers Gemini AI';
            document.getElementById('btnVoiceRecord').classList.add('hidden')
        }
    }
    
    async function processAudio(){
        const audioBlob=new Blob(audioChunks,{type:'audio/webm'});
        const base64Audio=await blobToBase64(audioBlob);
        const geminiKey=localStorage.getItem('bahia_gemini');
        try{
            const response=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiKey}`,{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({
                    contents:[{
                        parts:[
                            {inlineData:{mimeType:'audio/webm',data:base64Audio}},
                            {text:"Transcris cet audio en texte. Si c'est en arabe, transcris en arabe. Si c'est en fran√ßais, transcris en fran√ßais. Si c'est un m√©lange, transcris les deux langues. Retourne UNIQUEMENT le texte transcrit, sans explication ni commentaire."}
                        ]
                    }]
                })
            });
            const result=await response.json();
            let text='';
            if(result.candidates&&result.candidates[0]&&result.candidates[0].content){
                text=result.candidates[0].content.parts.map(p=>p.text||'').join('').trim()
            }
            if(!text&&result.error){throw new Error(result.error.message)}
            document.getElementById('voiceAnim').classList.remove('processing');
            document.getElementById('voiceStatus').textContent='‚úÖ Transcription termin√©e';
            document.getElementById('voiceSub').textContent='V√©rifiez et corrigez si n√©cessaire';
            document.getElementById('voiceResult').classList.remove('hidden');
            document.getElementById('voiceText').value=text;
            document.getElementById('btnVoiceConfirm').classList.remove('hidden');
            document.getElementById('voiceTimer').classList.add('hidden')
        }catch(e){
            console.error('Gemini error:',e);
            document.getElementById('voiceAnim').classList.remove('processing');
            document.getElementById('voiceStatus').textContent='‚ùå Erreur transcription';
            document.getElementById('voiceSub').textContent=e.message||'R√©essayez';
            document.getElementById('btnVoiceRecord').classList.remove('hidden');
            document.getElementById('btnVoiceRecord').textContent='üé§ R√©essayer';
            document.getElementById('btnVoiceRecord').className='btn btn-danger'
        }
    }
    
    function blobToBase64(blob){return new Promise((resolve,reject)=>{const reader=new FileReader();reader.onloadend=()=>{const base64=reader.result.split(',')[1];resolve(base64)};reader.onerror=reject;reader.readAsDataURL(blob)})}
    
    function confirmVoice(){
        const text=document.getElementById('voiceText').value.trim();
        if(voiceTargetId&&text){
            const target=document.getElementById(voiceTargetId);
            const existing=target.value.trim();
            target.value=existing?(existing+' '+text):text;
            // Trigger update
            if(voiceTargetId==='sigComment')updateSigPreview();
            else updateBtPreview()
        }
        document.getElementById('voiceModal').classList.add('hidden');
        toast('‚úÖ Texte ajout√©')
    }
    
    function cancelVoice(){
        if(isRecording){clearInterval(voiceTimerInterval);if(mediaRecorder&&mediaRecorder.state!=='inactive')mediaRecorder.stop();isRecording=false}
        document.getElementById('voiceModal').classList.add('hidden')
    }
    
    // ============ SIGNALEMENT TIMER ============
    function startSigTimer(){if(sigTimerInterval)return;document.getElementById('sigTimerStart').classList.add('hidden');document.getElementById('sigTimerStop').classList.remove('hidden');sigTimerInterval=setInterval(()=>{sigTimerSeconds++;updateSigTimerDisplay()},1000)}
    function stopSigTimer(){clearInterval(sigTimerInterval);sigTimerInterval=null;document.getElementById('sigTimerStart').classList.remove('hidden');document.getElementById('sigTimerStop').classList.add('hidden');document.getElementById('sigDuree').value=Math.ceil(sigTimerSeconds/60);updateSigPreview()}
    function resetSigTimer(){clearInterval(sigTimerInterval);sigTimerInterval=null;sigTimerSeconds=0;updateSigTimerDisplay();document.getElementById('sigTimerStart').classList.remove('hidden');document.getElementById('sigTimerStop').classList.add('hidden')}
    function updateSigTimerDisplay(){const h=Math.floor(sigTimerSeconds/3600),m=Math.floor((sigTimerSeconds%3600)/60),s=sigTimerSeconds%60;document.getElementById('sigTimerVal').textContent=String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0')}
    
    // ============ SIGNALEMENT ============
    function initSig(){document.getElementById('sigLoading').classList.add('hidden');document.getElementById('sigApp').classList.remove('hidden');document.getElementById('sigOpName').textContent=user.nom;document.getElementById('sigOpRole').textContent=ROLES[user.role]?.label||user.role;const lignes=[...new Set((db.machines||[]).map(m=>m.Ligne))];document.getElementById('sigLignes').innerHTML=lignes.map(l=>`<div class="chip" onclick="selectSigLigne(this,'${l}')">${l}</div>`).join('');document.getElementById('sigTechs').innerHTML=(db.techniciens||[]).map(t=>`<div class="tech-item" onclick="toggleSigTech(this,'${t.Nom}')"><input type="checkbox"><div><div class="tech-name">${t.Nom}</div><div class="tech-spec">${t.Specialite||''}</div></div></div>`).join('')}
    function selectSigLigne(el,v){document.querySelectorAll('#sigLignes .chip').forEach(c=>c.classList.remove('sel'));el.classList.add('sel');sigData.ligne=v;sigData.machine=sigData.zone=sigData.comp=sigData.ano='';const m=(db.machines||[]).filter(x=>x.Ligne===v);document.getElementById('sigMachines').innerHTML=m.map(x=>`<div class="chip" onclick="selectSigMachine(this,'${x.Machine}')">${x.Machine}</div>`).join('');show('sig3');hide(['sig4','sig5','sig6','sig7','sig8','sig9','sig10','sigPreviewCard']);updateSigPreview()}
    function selectSigMachine(el,v){document.querySelectorAll('#sigMachines .chip').forEach(c=>c.classList.remove('sel'));el.classList.add('sel');sigData.machine=v;sigData.zone=sigData.comp=sigData.ano='';const z=(db.zones||[]).filter(x=>x.Machine===v);document.getElementById('sigZone').innerHTML='<option value="">-- S√©lectionner --</option>'+z.map(x=>`<option value="${x.Zone}">${x.Zone}</option>`).join('');show('sig4');hide(['sig5','sig6','sig7','sig8','sig9','sig10','sigPreviewCard']);updateSigPreview()}
    function selectSigZone(v){sigData.zone=v;sigData.comp=sigData.ano='';if(!v){hide(['sig5','sig6','sig7','sig8','sig9','sig10','sigPreviewCard']);return}const c=(db.composants||[]).filter(x=>x.Zone===v);document.getElementById('sigComp').innerHTML='<option value="">-- S√©lectionner --</option>'+c.map(x=>`<option value="${x.Composant}">${x.Composant}</option>`).join('')+'<option value="Autre">‚ûï Autre</option>';show('sig5');hide(['sig6','sig7','sig8','sig9','sig10','sigPreviewCard']);updateSigPreview()}
    function selectSigComp(v){sigData.comp=v;sigData.ano='';document.getElementById('sigCompAutre').classList.toggle('hidden',v!=='Autre');if(!v){hide(['sig6','sig7','sig8','sig9','sig10','sigPreviewCard']);return}document.getElementById('sigAno').innerHTML='<option value="">-- S√©lectionner --</option>'+(db.anomalies||[]).map(a=>`<option value="${a.Anomalie}">${a.Anomalie}</option>`).join('')+'<option value="Autre">‚ûï Autre</option>';show('sig6');hide(['sig7','sig8','sig9','sig10','sigPreviewCard']);updateSigPreview()}
    function selectSigAno(v){sigData.ano=v;document.getElementById('sigAnoAutre').classList.toggle('hidden',v!=='Autre');if(!v){hide(['sig7','sig8','sig9','sig10','sigPreviewCard']);return}show(['sig7','sig8','sig9','sig10','sigPreviewCard']);updateSigPreview()}
    function toggleSigTech(el,n){el.classList.toggle('sel');el.querySelector('input').checked=el.classList.contains('sel');if(el.classList.contains('sel'))sigData.techs.push(n);else sigData.techs=sigData.techs.filter(t=>t!==n);const d=document.getElementById('sigSelTechs');d.classList.toggle('hidden',!sigData.techs.length);d.innerHTML='<strong>S√©lectionn√©s:</strong> '+sigData.techs.join(', ');updateSigPreview()}
    function setSigDur(v){document.getElementById('sigDuree').value=v;updateSigPreview()}
    function handleSigPhoto(inp){const f=inp.files[0];if(f)compressImg(f).then(r=>{sigPhoto=r.file;sigPhotoUrl=r.url;document.getElementById('sigPhotoImg').src=sigPhotoUrl;document.getElementById('sigPhotoPreview').classList.remove('hidden');updateSigPreview()})}
    function removeSigPhoto(){sigPhoto=sigPhotoUrl=null;document.getElementById('sigPhotoPreview').classList.add('hidden');document.getElementById('sigCam').value='';document.getElementById('sigGal').value='';updateSigPreview()}
    
    function updateSigPreview(){const comp=sigData.comp==='Autre'?document.getElementById('sigCompAutre').value||'Autre':sigData.comp,ano=sigData.ano==='Autre'?document.getElementById('sigAnoAutre').value||'Autre':sigData.ano,dur=sigTimerSeconds>0?Math.ceil(sigTimerSeconds/60):document.getElementById('sigDuree').value,com=document.getElementById('sigComment').value;let m=`üö® *SIGNALEMENT*\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;m+=`üë∑ ${user.nom}\n`;if(sigData.ligne)m+=`üè≠ ${sigData.ligne}\n`;if(sigData.machine)m+=`‚öôÔ∏è ${sigData.machine}\n`;if(sigData.zone)m+=`üìç ${sigData.zone}\n`;if(comp)m+=`üîß ${comp}\n`;if(ano)m+=`‚ö†Ô∏è ${ano}\n`;if(sigData.techs.length)m+=`üë®‚Äçüîß ${sigData.techs.join(', ')}\n`;if(dur)m+=`‚è±Ô∏è ${dur} min\n`;if(sigPhoto)m+=`üì∑ Photo\n`;if(com)m+=`üí¨ ${com}\n`;document.getElementById('sigPreview').textContent=m;const ok=sigData.ligne&&sigData.machine&&sigData.zone&&sigData.comp&&sigData.ano&&sigData.techs.length,can=ROLES[user?.role]?.edit!==false;document.getElementById('btnSaveSig').disabled=!ok||!can;document.getElementById('btnWaSig').disabled=!sigData.ano}
    
    async function saveSig(){const url=localStorage.getItem('bahia_url'),token=localStorage.getItem('bahia_token');showOverlay(editMode==='sig'?'Modification...':'Enregistrement...');try{const dur=sigTimerSeconds>0?Math.ceil(sigTimerSeconds/60):document.getElementById('sigDuree').value;const d={action:editMode==='sig'?'updateAnomalie':'saveAnomalie',token,id:editId,operateur:user.nom,ligne:sigData.ligne,machine:sigData.machine,zone:sigData.zone,composant:sigData.comp==='Autre'?document.getElementById('sigCompAutre').value:sigData.comp,anomalie:sigData.ano==='Autre'?document.getElementById('sigAnoAutre').value:sigData.ano,techniciens:sigData.techs.join(', '),duree:dur,commentaire:document.getElementById('sigComment').value,photo:sigPhotoUrl||'',userId:user?.id};const r=await fetch(url,{method:'POST',mode:'cors',redirect:'follow',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(d)});const res=await r.json();hideOverlay();if(res.error)throw new Error(res.error);savedSigId=res.id||editId;document.getElementById('sigSuccessId').textContent=savedSigId;document.querySelectorAll('#sigApp > .card, #sigApp > .timer-sm').forEach(c=>c.classList.add('hidden'));document.getElementById('sigSuccess').classList.remove('hidden');document.getElementById('sigBtns').classList.add('hidden');document.getElementById('btnResetSig').classList.remove('hidden');toast(editMode==='sig'?'‚úÖ Anomalie modifi√©e':'‚úÖ Anomalie enregistr√©e');editMode=null;editId=null;loadAnomalies()}catch(e){hideOverlay();toast('‚ùå '+e.message,'error')}}
    
    function sendWaSig(){const m=document.getElementById('sigPreview').textContent+(savedSigId?'\n\nüÜî '+savedSigId:'');window.location.href='whatsapp://send?text='+encodeURIComponent(m)}
    function resetSig(){editMode=null;editId=null;sigData={ligne:'',machine:'',zone:'',comp:'',ano:'',techs:[]};sigPhoto=sigPhotoUrl=savedSigId=null;resetSigTimer();document.getElementById('sigDuree').value='';document.getElementById('sigComment').value='';document.querySelectorAll('#sigLignes .chip,#sigMachines .chip,.tech-item').forEach(c=>c.classList.remove('sel'));document.querySelectorAll('.tech-item input').forEach(c=>c.checked=false);document.getElementById('sigSelTechs').classList.add('hidden');removeSigPhoto();document.getElementById('sigSuccess').classList.add('hidden');document.querySelectorAll('#sigApp > .card, #sigApp > .timer-sm').forEach(c=>c.classList.remove('hidden'));hide(['sig3','sig4','sig5','sig6','sig7','sig8','sig9','sig10','sigPreviewCard']);document.getElementById('sigBtns').classList.remove('hidden');document.getElementById('btnResetSig').classList.add('hidden');updateSigPreview()}
    
    // ============ EDIT/DELETE ANOMALIE ============
    function editAnomalie(id){const ano=allAno.find(a=>a.ID===id);if(!ano)return;editMode='sig';editId=id;goPage('pgSig',document.getElementById('navSig'));setTimeout(()=>{sigData.ligne=ano.Ligne||'';sigData.machine=ano.Machine||'';sigData.zone=ano.Zone||'';sigData.comp=ano.Composant||'';sigData.ano=ano.Anomalie||'';sigData.techs=(ano.Techniciens||'').split(', ').filter(t=>t);document.querySelectorAll('#sigLignes .chip').forEach(c=>{if(c.textContent===ano.Ligne)c.classList.add('sel')});const m=(db.machines||[]).filter(x=>x.Ligne===ano.Ligne);document.getElementById('sigMachines').innerHTML=m.map(x=>`<div class="chip ${x.Machine===ano.Machine?'sel':''}" onclick="selectSigMachine(this,'${x.Machine}')">${x.Machine}</div>`).join('');const z=(db.zones||[]).filter(x=>x.Machine===ano.Machine);document.getElementById('sigZone').innerHTML='<option value="">-- S√©lectionner --</option>'+z.map(x=>`<option value="${x.Zone}" ${x.Zone===ano.Zone?'selected':''}>${x.Zone}</option>`).join('');const c=(db.composants||[]).filter(x=>x.Zone===ano.Zone);document.getElementById('sigComp').innerHTML='<option value="">-- S√©lectionner --</option>'+c.map(x=>`<option value="${x.Composant}" ${x.Composant===ano.Composant?'selected':''}>${x.Composant}</option>`).join('')+'<option value="Autre">‚ûï Autre</option>';document.getElementById('sigAno').innerHTML='<option value="">-- S√©lectionner --</option>'+(db.anomalies||[]).map(a=>`<option value="${a.Anomalie}" ${a.Anomalie===ano.Anomalie?'selected':''}>${a.Anomalie}</option>`).join('')+'<option value="Autre">‚ûï Autre</option>';document.querySelectorAll('.tech-item').forEach(el=>{const n=el.querySelector('.tech-name').textContent;if(sigData.techs.includes(n)){el.classList.add('sel');el.querySelector('input').checked=true}});document.getElementById('sigDuree').value=ano.Duree||'';document.getElementById('sigComment').value=ano.Commentaire||'';show(['sig3','sig4','sig5','sig6','sig7','sig8','sig9','sig10','sigPreviewCard']);updateSigPreview();toast('‚úèÔ∏è Mode √©dition','info')},100)}
    
    function deleteAnomalie(id){deleteType='ano';deleteId=id;document.getElementById('deleteMsg').textContent=`Voulez-vous vraiment supprimer l'anomalie ${id} ?`;document.getElementById('deleteModal').classList.remove('hidden')}
    
    // ============ MAINTENANCE ============
    function initMaint(){document.getElementById('maintLoading').classList.add('hidden');document.getElementById('maintApp').classList.remove('hidden');document.getElementById('btTech').innerHTML='<option value="">-- S√©lectionner --</option>'+(db.techniciens||[]).map(t=>`<option value="${t.Nom}">${t.Nom}</option>`).join('');renderPieces('piecesBT','bt')}
    
    async function loadAnomalies(){const url=localStorage.getItem('bahia_url'),token=localStorage.getItem('bahia_token');try{const r=await fetch(`${url}?token=${encodeURIComponent(token)}&action=getAnomaliesEnCours`);const res=await r.json();allAno=res.anomalies||[];filterAno(document.querySelector('#pgMaint .filters .fbtn.active'),currentAnoFilter);updateDashboard()}catch(e){console.error(e)}}
    
    async function loadBTs(){const url=localStorage.getItem('bahia_url'),token=localStorage.getItem('bahia_token');try{const r=await fetch(`${url}?token=${encodeURIComponent(token)}&action=getBonsTravail`);const res=await r.json();allBT=res.bts||[];updateBTSelect()}catch(e){console.error(e);allBT=[]}}
    
    function updateBTSelect(){const sel=document.getElementById('pdrBtRef');sel.innerHTML='<option value="">-- Aucun BT --</option>'+allBT.filter(b=>b.Statut==='En cours'||b.Statut==='Attente pi√®ce').map(b=>`<option value="${b.BT_ID}">${b.BT_ID} - ${b.Machine||''}</option>`).join('')}
    
    function filterAno(el,type){document.querySelectorAll('#pgMaint .filters .fbtn').forEach(b=>b.classList.remove('active'));el.classList.add('active');currentAnoFilter=type;let f=allAno;if(type==='encours')f=allAno.filter(a=>!a.Statut||a.Statut==='En cours');else if(type==='attente')f=allAno.filter(a=>a.Statut==='Attente pi√®ce');else if(type==='cloture')f=allAno.filter(a=>a.Statut==='Cl√¥tur√©');renderAnoList(f)}
    function filterAnoSearch(){const s=document.getElementById('searchAno').value.toLowerCase();const f=allAno.filter(a=>a.ID?.toLowerCase().includes(s)||a.Machine?.toLowerCase().includes(s)||a.Anomalie?.toLowerCase().includes(s));renderAnoList(f)}
    
    function renderAnoList(list){const d=document.getElementById('anoList'),canEdit=ROLES[user?.role]?.edit!==false;if(!list.length){d.innerHTML='<div class="empty"><div class="eico">üìã</div>Aucune anomalie</div>';return}d.innerHTML=list.map((a,i)=>`<div class="list-item" onclick="selectAno(${allAno.indexOf(a)})" style="padding-right:${canEdit?'90px':'14px'}"><div class="list-row"><span class="list-id">${a.ID}</span><span class="badge ${a.Statut==='Cl√¥tur√©'?'ok':(a.Statut==='Attente pi√®ce'?'info':'warn')}">${a.Statut||'En cours'}</span></div><div class="list-title">${a.Machine} - ${a.Anomalie}</div><div class="list-sub">${a.Date||''} ${a.Heure||''}</div>${canEdit?`<div class="list-actions"><button class="act-btn edit" onclick="event.stopPropagation();editAnomalie('${a.ID}')">‚úèÔ∏è</button><button class="act-btn del" onclick="event.stopPropagation();deleteAnomalie('${a.ID}')">üóëÔ∏è</button></div>`:''}</div>`).join('')}
    
    function selectAno(i){btData.ano=allAno[i];btData.statut=btData.ano.Statut||'En cours';document.querySelectorAll('.list-item').forEach((el,j)=>el.classList.toggle('sel',j===i));const now=new Date(),btId='BT-'+now.getFullYear()+String(now.getMonth()+1).padStart(2,'0')+String(now.getDate()).padStart(2,'0')+'-'+String(Math.floor(Math.random()*9000)+1000);document.getElementById('btId').textContent=btId;document.getElementById('btAnoRef').textContent=btData.ano.ID;document.getElementById('btAnoMachine').textContent=btData.ano.Machine||'';document.querySelectorAll('.btact').forEach(b=>{b.style.background=b.textContent.includes(btData.statut.split(' ')[0])?'#fff':'rgba(255,255,255,.2)';b.style.color=b.textContent.includes(btData.statut.split(' ')[0])?'var(--secondary)':'#fff'});document.querySelectorAll('#btForm .chips .chip').forEach(c=>{c.classList.toggle('sel',c.textContent.includes(btData.statut.split(' ')[0]))});document.getElementById('btForm').classList.remove('hidden');updateBtPreview()}
    
    function renderPieces(cid,mode){const d=document.getElementById(cid),arr=mode==='bt'?btData.pieces:pdrData.pieces;let list=allPieces;if(mode==='pdr'&&currentPdrType!=='all')list=allPieces.filter(p=>p.Type===currentPdrType);if(!list.length){d.innerHTML='<div class="empty" style="padding:20px"><div class="eico">üì¶</div>Aucune pi√®ce</div>';return}d.innerHTML=list.map((p,i)=>{const s=arr.find(x=>x.code===p.Code_JDE);return`<div class="piece ${s?'sel':''}" onclick="togglePiece(${allPieces.indexOf(p)},'${mode}')"><input type="checkbox" ${s?'checked':''}><div class="piece-info"><div class="piece-code">${p.Code_JDE}</div><div class="piece-name">${p.Designation}</div><div class="piece-stock">Stock: ${p.Stock||0} ${p.Unite||'U'}</div></div><div class="piece-qty ${s?'':'hidden'}"><input type="number" min="1" value="${s?.qty||1}" onchange="updatePieceQty(${allPieces.indexOf(p)},this.value,'${mode}')" onclick="event.stopPropagation()"></div></div>`}).join('')}
    function togglePiece(i,mode){const p=allPieces[i],arr=mode==='bt'?btData.pieces:pdrData.pieces,idx=arr.findIndex(x=>x.code===p.Code_JDE);if(idx>=0)arr.splice(idx,1);else arr.push({code:p.Code_JDE,designation:p.Designation,qty:1,unite:p.Unite||'U'});renderPieces(mode==='bt'?'piecesBT':'piecesPDR',mode);updateSelPieces(mode);if(mode==='bt')updateBtPreview();else updatePdrPreview()}
    function updatePieceQty(i,q,mode){const p=allPieces[i],arr=mode==='bt'?btData.pieces:pdrData.pieces,it=arr.find(x=>x.code===p.Code_JDE);if(it)it.qty=parseInt(q)||1;updateSelPieces(mode);if(mode==='bt')updateBtPreview();else updatePdrPreview()}
    function updateSelPieces(mode){const arr=mode==='bt'?btData.pieces:pdrData.pieces,d=document.getElementById(mode==='bt'?'selPiecesBT':'selPiecesPDR');d.classList.toggle('hidden',!arr.length);d.innerHTML='<strong>S√©lectionn√©es:</strong><br>'+arr.map(p=>`<span class="tag">${p.code} x${p.qty}</span>`).join('')}
    function filterPiecesBT(){const s=document.getElementById('searchPieceBT').value.toLowerCase();const f=allPieces.filter(p=>p.Code_JDE.toLowerCase().includes(s)||p.Designation.toLowerCase().includes(s));renderFilteredPieces('piecesBT',f,'bt')}
    function renderFilteredPieces(cid,list,mode){const d=document.getElementById(cid),arr=mode==='bt'?btData.pieces:pdrData.pieces;if(!list.length){d.innerHTML='<div class="empty" style="padding:20px">Aucune pi√®ce trouv√©e</div>';return}d.innerHTML=list.map(p=>{const i=allPieces.indexOf(p),s=arr.find(x=>x.code===p.Code_JDE);return`<div class="piece ${s?'sel':''}" onclick="togglePiece(${i},'${mode}')"><input type="checkbox" ${s?'checked':''}><div class="piece-info"><div class="piece-code">${p.Code_JDE}</div><div class="piece-name">${p.Designation}</div><div class="piece-stock">Stock: ${p.Stock||0} ${p.Unite||'U'}</div></div><div class="piece-qty ${s?'':'hidden'}"><input type="number" min="1" value="${s?.qty||1}" onchange="updatePieceQty(${i},this.value,'${mode}')" onclick="event.stopPropagation()"></div></div>`}).join('')}
    
    function startTimer(){if(timerInterval)return;document.getElementById('timerStart').classList.add('hidden');document.getElementById('timerStop').classList.remove('hidden');timerInterval=setInterval(()=>{timerSeconds++;updateTimerDisplay()},1000)}
    function stopTimer(){clearInterval(timerInterval);timerInterval=null;document.getElementById('timerStart').classList.remove('hidden');document.getElementById('timerStop').classList.add('hidden');document.getElementById('btDuree').value=Math.ceil(timerSeconds/60);updateBtPreview()}
    function resetTimer(){clearInterval(timerInterval);timerInterval=null;timerSeconds=0;updateTimerDisplay();document.getElementById('timerStart').classList.remove('hidden');document.getElementById('timerStop').classList.add('hidden')}
    function updateTimerDisplay(){const h=Math.floor(timerSeconds/3600),m=Math.floor((timerSeconds%3600)/60),s=timerSeconds%60;document.getElementById('timerDisplay').textContent=String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0')}
    
    function setBtStatut(el,v){document.querySelectorAll('#btForm .chips .chip').forEach(c=>c.classList.remove('sel'));el.classList.add('sel');btData.statut=v;document.querySelectorAll('.btact').forEach(b=>{b.style.background=b.textContent.includes(v.split(' ')[0])?'#fff':'rgba(255,255,255,.2)';b.style.color=b.textContent.includes(v.split(' ')[0])?'var(--secondary)':'#fff'});updateBtPreview()}
    function quickBtStatus(v){btData.statut=v;document.querySelectorAll('.btact').forEach(b=>{b.style.background=b.textContent.includes(v.split(' ')[0])?'#fff':'rgba(255,255,255,.2)';b.style.color=b.textContent.includes(v.split(' ')[0])?'var(--secondary)':'#fff'});document.querySelectorAll('#btForm .chips .chip').forEach(c=>{c.classList.toggle('sel',c.textContent.includes(v.split(' ')[0]))});updateBtPreview()}
    
    function updateBtPreview(){const a=btData.ano,t=document.getElementById('btTech').value,c=document.getElementById('btCause').value,diag=document.getElementById('btDiag').value,act=document.getElementById('btAction').value,det=document.getElementById('btActionDetail').value,dur=document.getElementById('btDuree').value;let m=`üîß *BON DE TRAVAIL*\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;m+=`üìã ${document.getElementById('btId').textContent}\n`;if(a){m+=`üîó ${a.ID}\n‚öôÔ∏è ${a.Machine}\n‚ö†Ô∏è ${a.Anomalie}\n`}m+=`‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;if(t)m+=`üë®‚Äçüîß ${t}\n`;if(c)m+=`üîç ${c}\n`;if(diag)m+=`üìù ${diag}\n`;if(act)m+=`üõ†Ô∏è ${act}\n`;if(det)m+=`üìù ${det}\n`;if(btData.pieces.length){m+=`üì¶ Pi√®ces:\n`;btData.pieces.forEach(p=>m+=`   ‚Ä¢ ${p.code} x${p.qty}\n`)}if(dur)m+=`‚è±Ô∏è ${dur} min\n`;if(btData.statut)m+=`‚úÖ ${btData.statut}\n`;document.getElementById('btPreview').textContent=m;const ok=a&&btData.statut,can=ROLES[user?.role]?.edit!==false;document.getElementById('btnSaveBT').disabled=!ok||!can;document.getElementById('btnWaBT').disabled=!a}
    
    async function saveBT(){const url=localStorage.getItem('bahia_url'),token=localStorage.getItem('bahia_token');showOverlay('Enregistrement BT...');try{const d={action:'saveBT',token,btId:document.getElementById('btId').textContent,anomalieId:btData.ano.ID,technicien:document.getElementById('btTech').value,cause:document.getElementById('btCause').value,diagnostic:document.getElementById('btDiag').value,actionType:document.getElementById('btAction').value,actionDetail:document.getElementById('btActionDetail').value,pieces:JSON.stringify(btData.pieces),duree:document.getElementById('btDuree').value,statut:btData.statut,userId:user?.id};const r=await fetch(url,{method:'POST',mode:'cors',redirect:'follow',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(d)});const res=await r.json();hideOverlay();if(res.error)throw new Error(res.error);savedBtId=res.btId||document.getElementById('btId').textContent;document.getElementById('btSuccessId').textContent=savedBtId;document.querySelectorAll('#maintApp > .card,#maintApp > .filters,#maintApp > .search,#maintApp > .list-box,#btForm').forEach(c=>c.classList.add('hidden'));document.getElementById('btSuccess').classList.remove('hidden');document.getElementById('maintBtns').classList.add('hidden');document.getElementById('btnResetBT').classList.remove('hidden');toast('‚úÖ BT enregistr√©');loadAnomalies();loadBTs()}catch(e){hideOverlay();toast('‚ùå '+e.message,'error')}}
    function sendWaBT(){window.location.href='whatsapp://send?text='+encodeURIComponent(document.getElementById('btPreview').textContent)}
    function resetBT(){btData={ano:null,pieces:[],statut:''};savedBtId=null;resetTimer();document.getElementById('searchAno').value='';document.getElementById('btTech').value='';document.getElementById('btCause').value='';document.getElementById('btDiag').value='';document.getElementById('btAction').value='';document.getElementById('btActionDetail').value='';document.getElementById('btDuree').value='';document.getElementById('searchPieceBT').value='';document.querySelectorAll('#btForm .chips .chip,.list-item,.btact').forEach(c=>c.classList.remove('sel'));document.querySelectorAll('.btact').forEach(b=>{b.style.background='rgba(255,255,255,.2)';b.style.color='#fff'});document.getElementById('selPiecesBT').classList.add('hidden');renderPieces('piecesBT','bt');filterAno(document.querySelector('#pgMaint .filters .fbtn.active'),currentAnoFilter);document.getElementById('btSuccess').classList.add('hidden');document.getElementById('btForm').classList.add('hidden');document.querySelectorAll('#maintApp > .card,#maintApp > .filters,#maintApp > .search,#maintApp > .list-box').forEach(c=>c.classList.remove('hidden'));document.getElementById('maintBtns').classList.remove('hidden');document.getElementById('btnResetBT').classList.add('hidden');updateBtPreview()}
    
    // ============ PDR ============
    function initPDR(){document.getElementById('pdrLoading').classList.add('hidden');document.getElementById('pdrApp').classList.remove('hidden');document.getElementById('pdrTotal').textContent=allPieces.length;document.getElementById('pdrBas').textContent=allPieces.filter(p=>(p.Stock||0)<=5).length;const m=[...new Set((db.machines||[]).map(x=>x.Machine))];document.getElementById('pdrMachine').innerHTML='<option value="">-- S√©lectionner --</option>'+m.map(x=>`<option value="${x}">${x}</option>`).join('');renderPieces('piecesPDR','pdr')}
    function filterPiecesPDR(){const s=document.getElementById('searchPiecePDR').value.toLowerCase();let f=allPieces.filter(p=>p.Code_JDE.toLowerCase().includes(s)||p.Designation.toLowerCase().includes(s));if(currentPdrType!=='all')f=f.filter(p=>p.Type===currentPdrType);renderFilteredPieces('piecesPDR',f,'pdr')}
    function filterPdrType(el,type){document.querySelectorAll('#pgPDR .card .filters .fbtn').forEach(b=>b.classList.remove('active'));el.classList.add('active');currentPdrType=type;filterPiecesPDR()}
    function updatePdrPreview(){const m=document.getElementById('pdrMachine').value,mot=document.getElementById('pdrMotif').value,bt=document.getElementById('pdrBtRef').value;let msg=`üì¶ *SORTIE PDR*\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;msg+=`üë§ ${user.nom}\n`;if(m)msg+=`‚öôÔ∏è ${m}\n`;if(mot)msg+=`üìã ${mot}\n`;if(bt)msg+=`üîó ${bt}\n`;if(pdrData.pieces.length){msg+=`‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüì¶ Pi√®ces:\n`;pdrData.pieces.forEach(p=>msg+=`   ‚Ä¢ ${p.code} x${p.qty}\n`)}document.getElementById('pdrPreview').textContent=msg;document.getElementById('pdrPreviewCard').classList.toggle('hidden',!pdrData.pieces.length);const ok=m&&mot&&pdrData.pieces.length,can=ROLES[user?.role]?.edit!==false;document.getElementById('btnSavePDR').disabled=!ok||!can}
    async function savePDR(){const url=localStorage.getItem('bahia_url'),token=localStorage.getItem('bahia_token');showOverlay('Enregistrement...');try{const d={action:'saveSortiePDR',token,machine:document.getElementById('pdrMachine').value,motif:document.getElementById('pdrMotif').value,btRef:document.getElementById('pdrBtRef').value,demandeur:user.nom,pieces:JSON.stringify(pdrData.pieces),userId:user?.id};const r=await fetch(url,{method:'POST',mode:'cors',redirect:'follow',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(d)});const res=await r.json();hideOverlay();if(res.error)throw new Error(res.error);savedPdrId=res.sortieId;document.getElementById('pdrSuccessId').textContent=savedPdrId;document.querySelectorAll('#pdrApp > .card,#pdrApp > .stats').forEach(c=>c.classList.add('hidden'));document.getElementById('pdrSuccess').classList.remove('hidden');document.getElementById('pdrBtns').classList.add('hidden');document.getElementById('btnResetPDR').classList.remove('hidden');toast('‚úÖ Sortie enregistr√©e');loadHistory()}catch(e){hideOverlay();toast('‚ùå '+e.message,'error')}}
    function resetPDR(){pdrData={pieces:[]};savedPdrId=null;document.getElementById('pdrMachine').value='';document.getElementById('pdrMotif').value='';document.getElementById('pdrBtRef').value='';document.getElementById('searchPiecePDR').value='';document.getElementById('selPiecesPDR').classList.add('hidden');renderPieces('piecesPDR','pdr');document.getElementById('pdrSuccess').classList.add('hidden');document.querySelectorAll('#pdrApp > .card,#pdrApp > .stats').forEach(c=>c.classList.remove('hidden'));document.getElementById('pdrPreviewCard').classList.add('hidden');document.getElementById('pdrBtns').classList.remove('hidden');document.getElementById('btnResetPDR').classList.add('hidden');updatePdrPreview()}
    async function loadHistory(){const url=localStorage.getItem('bahia_url'),token=localStorage.getItem('bahia_token');try{const r=await fetch(`${url}?token=${encodeURIComponent(token)}&action=getHistorySorties`);const res=await r.json();history=res.sorties||[];renderHistory()}catch(e){console.error(e)}}
    function renderHistory(){const t=document.getElementById('pdrHistory');if(!history.length){t.innerHTML='<tr><td colspan="4" style="text-align:center;padding:20px;color:var(--g400)">Aucune sortie</td></tr>';return}t.innerHTML=history.slice(0,30).map(s=>`<tr><td style="padding:8px">${formatDate(s.Date)}</td><td style="padding:8px;font-weight:600;color:var(--primary)">${s.Code_JDE||''}</td><td style="padding:8px;text-align:center">${s.Quantite||''}</td><td style="padding:8px">${s.Machine||'-'}</td></tr>`).join('')}
    function formatDate(d){if(!d)return'';if(typeof d==='string'&&d.includes('T'))return new Date(d).toLocaleDateString('fr-FR');return d}
    
    // ============ PRINT ============
    function showPrintModal(){document.getElementById('printModal').classList.remove('hidden');printType=null;document.querySelectorAll('.print-option').forEach(o=>o.classList.remove('sel'));document.getElementById('btnPrint').disabled=true}
    function hidePrintModal(){document.getElementById('printModal').classList.add('hidden')}
    function selectPrintType(type){printType=type;document.querySelectorAll('.print-option').forEach(o=>o.classList.remove('sel'));event.currentTarget.classList.add('sel');document.getElementById('btnPrint').disabled=false}
    function doPrint(){hidePrintModal();const area=document.getElementById('printArea');let html='<style>body{font-family:Arial,sans-serif}table{width:100%;border-collapse:collapse;margin-top:20px}th,td{border:1px solid #ddd;padding:8px;text-align:left}th{background:#1e40af;color:#fff}h1{color:#1e40af}tr:nth-child(even){background:#f9f9f9}.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}.logo{font-size:40px}</style>';html+=`<div class="header"><div><span class="logo">üè≠</span> <strong>BAHIA AGADIR - GMAO</strong></div><div>Imprim√© le ${new Date().toLocaleDateString('fr-FR')} √† ${new Date().toLocaleTimeString('fr-FR')}</div></div>`;
    if(printType==='sig'){html+='<h1>üìã Historique des Signalements</h1>';html+='<table><thead><tr><th>ID</th><th>Date</th><th>Machine</th><th>Anomalie</th><th>Techniciens</th><th>Statut</th></tr></thead><tbody>';allAno.forEach(a=>{html+=`<tr><td>${a.ID||''}</td><td>${a.Date||''}</td><td>${a.Machine||''}</td><td>${a.Anomalie||''}</td><td>${a.Techniciens||''}</td><td>${a.Statut||'En cours'}</td></tr>`});html+='</tbody></table>'}
    else if(printType==='bt'){html+='<h1>üîß Historique des Bons de Travail</h1>';html+='<table><thead><tr><th>BT ID</th><th>Anomalie</th><th>Machine</th><th>Technicien</th><th>Action</th><th>Dur√©e</th><th>Statut</th></tr></thead><tbody>';allBT.forEach(b=>{html+=`<tr><td>${b.BT_ID||''}</td><td>${b.Anomalie_ID||''}</td><td>${b.Machine||''}</td><td>${b.Technicien||''}</td><td>${b.Action||''}</td><td>${b.Duree||''} min</td><td>${b.Statut||''}</td></tr>`});html+='</tbody></table>'}
    else if(printType==='pdr'){html+='<h1>üì¶ Historique des Sorties PDR</h1>';html+='<table><thead><tr><th>Date</th><th>Code JDE</th><th>D√©signation</th><th>Quantit√©</th><th>Machine</th><th>Motif</th><th>BT Ref</th></tr></thead><tbody>';history.forEach(s=>{html+=`<tr><td>${formatDate(s.Date)}</td><td>${s.Code_JDE||''}</td><td>${s.Designation||''}</td><td>${s.Quantite||''}</td><td>${s.Machine||''}</td><td>${s.Motif||''}</td><td>${s.BT_Ref||'-'}</td></tr>`});html+='</tbody></table>'}
    area.innerHTML=html;area.classList.remove('hidden');window.print();setTimeout(()=>area.classList.add('hidden'),500)}
    
    // ============ DELETE MODAL ============
    function hideDeleteModal(){document.getElementById('deleteModal').classList.add('hidden')}
    async function confirmDelete(){hideDeleteModal();const url=localStorage.getItem('bahia_url'),token=localStorage.getItem('bahia_token');showOverlay('Suppression...');try{const d={action:deleteType==='ano'?'deleteAnomalie':'deleteBT',token,id:deleteId,userId:user?.id};const r=await fetch(url,{method:'POST',mode:'cors',redirect:'follow',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(d)});const res=await r.json();hideOverlay();if(res.error)throw new Error(res.error);toast('‚úÖ Supprim√©');loadAnomalies();loadBTs()}catch(e){hideOverlay();toast('‚ùå '+e.message,'error')}}
    
    // ============ UTILITIES ============
    function show(ids){(Array.isArray(ids)?ids:[ids]).forEach(id=>document.getElementById(id)?.classList.remove('hidden'))}
    function hide(ids){(Array.isArray(ids)?ids:[ids]).forEach(id=>document.getElementById(id)?.classList.add('hidden'))}
    function toast(m,type='success'){const t=document.createElement('div');t.className='toast '+type;t.textContent=m;document.body.appendChild(t);setTimeout(()=>t.remove(),3000)}
    function showOverlay(t){document.getElementById('overlayText').textContent=t;document.getElementById('overlay').classList.remove('hidden')}
    function hideOverlay(){document.getElementById('overlay').classList.add('hidden')}
    function compressImg(file,maxSize=1024,quality=0.7){return new Promise(resolve=>{const reader=new FileReader();reader.onload=e=>{const img=new Image();img.onload=()=>{let w=img.width,h=img.height;if(w>h){if(w>maxSize){h=Math.round(h*maxSize/w);w=maxSize}}else{if(h>maxSize){w=Math.round(w*maxSize/h);h=maxSize}}const canvas=document.createElement('canvas');canvas.width=w;canvas.height=h;canvas.getContext('2d').drawImage(img,0,0,w,h);const url=canvas.toDataURL('image/jpeg',quality);fetch(url).then(r=>r.blob()).then(blob=>{resolve({file:new File([blob],'photo.jpg',{type:'image/jpeg'}),url})})};img.src=e.target.result};reader.readAsDataURL(file)})}
    if('serviceWorker'in navigator)navigator.serviceWorker.register('sw.js').catch(e=>{});
    </script>
</body>
</html>
